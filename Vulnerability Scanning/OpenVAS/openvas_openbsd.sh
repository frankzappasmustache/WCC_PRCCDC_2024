#!/bin/sh

# Install required packages
pkg_add -z rsync curl gnutls postgresql-server postgresql-client python3 py3-pip git

# Enable and start PostgreSQL
rcctl enable postgresql
rcctl start postgresql

# Initialize PostgreSQL database
su - _postgresql
initdb -D /var/postgresql/data -U postgres -A md5 -W
exit

# Download and install OpenVAS
git clone https://github.com/greenbone/gvm-libs.git
git clone https://github.com/greenbone/gvmd.git
git clone https://github.com/greenbone/openvas.git
git clone https://github.com/greenbone/gsa.git
git clone https://github.com/greenbone/gvm-tools.git
cd gvm-libs && git checkout tags/v21.4.3 && cd ..
cd gvmd && git checkout tags/v21.4.3 && cd ..
cd openvas && git checkout tags/v21.4.3 && cd ..
cd gsa && git checkout tags/v21.4.3 && cd ..
cd gvm-tools && git checkout tags/v21.4.0 && cd ..
for i in gvm-libs gvmd openvas gsa gvm-tools; do
    cd $i && mkdir build && cd build
    cmake ..
    make
    doas make install
    cd ../..
done

# Configure OpenVAS
echo "local all all trust" >> /var/postgresql/data/pg_hba.conf
echo "host all all 127.0.0.1/32 trust" >> /var/postgresql/data/pg_hba.conf
rcctl restart postgresql

# Initialize OpenVAS
doas -u _gvm greenbone-scapdata-sync
doas -u _gvm greenbone-certdata-sync
doas -u _gvm gvmd --create-user=admin --password=admin
doas -u _gvm gvmd --modify-setting 78eceaec-3385-11ea-b237-28d24461215b --value $(doas -u _gvm gvmd --get-users --verbose | grep admin | cut -d" " -f2)
doas -u _gvm gvmd --modify-scanner=$(doas -u _gvm gvmd --get-scanners | grep "20 " | cut -d" " -f1) --scanner-host=/var/run/openvassd.sock
doas -u _gvm gvmd --create-scanner="OpenVAS Default" --scanner-host=/var/run/openvassd.sock

# Start OpenVAS services
doas rcctl enable gvmd
doas rcctl start gvmd
doas rcctl enable openvas_scanner
doas rcctl start openvas_scanner
doas rcctl enable gsad
doas rcctl start gsad
